<!DOCTYPE html>

<html>

    <head>

        <title>Cube</title>

        <meta charset="utf-8">

        <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
        
    </head>

    <body>

        <table>

            <thead>
                <tr>
                    <th>Message type</th>
                    <th>Total in last complete* hour</th>
                    <th>Total in last complete* day</th>
                </tr>
            </thead>

            <tbody></tbody>
        </table>
        
        <script>(function () { "use strict";
        
            var cubeBaseUrl = "http://eventcube.red-gate.com/1.0/";
            
            var eventUrl = cubeBaseUrl + "event";
            
            var metricUrl = cubeBaseUrl + "metric";
            
            var typesUrl = cubeBaseUrl + "types"

            var getTotalForLastCompletePeriod = function (type, period) {

                return $.getJSON(metricUrl, {

                    expression: "sum(" + type + ")",
                    step: period,
                    limit: 1
                });
            };
            
            var getMessageTypeLink = function (type) {
                
                var parameters = {

                    expression: type + "(payload,headers,messageType)",
                    limit: 1
                };
                
                return   "<a href='" + eventUrl + "?" + $.param(parameters) + "'>"
                       + type + "</a>";
            }

            var insertCell = function (rowIndex, columnIndex, contents) {

                $("tbody").children("tr")
                          .eq(rowIndex)
                          .children("td")
                          .eq(columnIndex)
                          .html(contents);
            };

            var loadMetricInCell = function (rowIndex, columnIndex, request) {

                var onRequestSuccess = function (response) {

                    insertCell(rowIndex, columnIndex, response[0].value);
                };
                
                var onRequestFailure = function () {

                    insertCell(rowIndex, columnIndex, "Failed to load metric");
                };
            
                $.when(request).then(onRequestSuccess, onRequestFailure);
            };

            var loadMetricsInRow = function (rowIndex, type) {

                loadMetricInCell(
                    rowIndex, 1, getTotalForLastCompletePeriod(type, 36e5));

                loadMetricInCell(
                    rowIndex, 2, getTotalForLastCompletePeriod(type, 864e5));
            };

            var loadAllMetricsInTable = function (types) {

                types.forEach(function (type, index) {

                    var loadingMessage = "Loading metric...";

                    $("tbody").append(
                          "<tr><td>" + getMessageTypeLink(type) + "</td><td>"
                        + loadingMessage + "</td><td>"
                        + loadingMessage + "</td></tr>");

                    loadMetricsInRow(index, type);
                });
            };

            var includeMessageType = function (type) {

                var ignoredMessageTypes = ["cube_compute", "cube_request"];

                return ignoredMessageTypes.indexOf(type) === -1;
            };

            var getTypes = $.get(typesUrl);

            var onGetTypesSuccess = function (types) {

                loadAllMetricsInTable(types.filter(includeMessageType));
            };
            
            var onGetTypesFailure = function () {

                var errorMessage = "Failed to load known message types";

                $("tbody").append(
                    "<tr><td colspan='3'>" + errorMessage + "</td></tr>");
            };
            
            $.when(getTypes).then(onGetTypesSuccess, onGetTypesFailure);

        }());</script>

    </body>

</html>