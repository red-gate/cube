<!DOCTYPE html>

<html>

    <head>

        <title>Cube</title>

        <meta charset="utf-8">

        <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>

    </head>

    <body>

        <table>

            <thead>
                <tr>
                    <th>Message type</th>
                    <th>Total in last complete hour</th>
                    <th>Total in last complete day</th>
                </tr>
            </thead>

            <tbody></tbody>
        </table>

        <script>(function () { "use strict";

            $.support.cors = true;

            var cubeBaseUrl = "http://eventcube.red-gate.com/1.0/";

            var getTotalMetricUrl = function (type, period) {

                var parameters = {

                    expression: "sum(" + type + ")",
                    step: period,
                    limit: 1
                };

                return cubeBaseUrl + "metric?" + $.param(parameters);
            };

            var getCell = function (table, rowIndex, columnIndex) {

                return table.children("tr")
                            .eq(rowIndex)
                            .children("td")
                            .eq(columnIndex);
            };

            var loadMetricInCell = function (cell, metricUrl) {

                var onRequestSuccess = function (response) {

                    cell.html(response[0].value);
                };

                var onRequestFailure = function () {

                    cell.html("Failed to load metric");
                };

                $.get(metricUrl).then(onRequestSuccess, onRequestFailure);
            };

            var loadAllMetricsInTable = function (table, types) {

                types.forEach(function (type, index) {

                    var loadingMessage = "Loading metric...";

                    table.append(
                        "<tr>"
                      + "<td>" + type + "</td>"
                      + "<td>" + loadingMessage + "</td>"
                      + "<td>" + loadingMessage + "</td>"
                      + "</tr>");

                    loadMetricInCell(
                        getCell(table, index, 1),
                        getTotalMetricUrl(type, 36e5));

                    loadMetricInCell(
                        getCell(table, index, 2),
                        getTotalMetricUrl(type, 864e5));
                });
            };

            var onGetTypesSuccess = function (types) {

                var displayedMessageTypes = types.filter(function (type) {

                    var ignoredMessageTypes = ["cube_compute", "cube_request"];

                    return ignoredMessageTypes.indexOf(type) === -1;
                });

                loadAllMetricsInTable($("tbody"), displayedMessageTypes);
            };

            var onGetTypesFailure = function (request, textStatus, errorThrown) {

                $("tbody").append(
                    "<tr><td colspan='3'>Failed to load known message types. "
                  + errorThrown + "</td></tr>");
            };

            $.get(cubeBaseUrl + "types")
             .then(onGetTypesSuccess, onGetTypesFailure);

        }());</script>

    </body>

</html>