<!DOCTYPE html>

<html>

    <head>

        <title>Cube</title>

        <meta charset="utf-8">

        <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
        <script src="http://knockoutjs.com/downloads/knockout-3.3.0.js"></script>

    </head>

    <body>

        <table data-bind="foreach: errors">
            <tr>
                <td data-bind="text: message" />
            </tr>
        </table>

        <table>

            <thead>
                <tr>
                    <th>Message type</th>
                    <th>Total in last complete hour</th>
                    <th>Total in last complete day</th>
                </tr>
            </thead>

            <tbody data-bind="foreach: types">
                <tr>
                    <td data-bind="with: type">
                        <a data-bind="text: value, attr: { href: url }" />
                    </td>
                    <td data-bind="with: totalInLastCompletedHour">
                        <a data-bind="text: value, attr: { href: url }" />
                    </td>
                    <td data-bind="with: totalInLastCompletedDay">
                        <a data-bind="text: value, attr: { href: url }" />
                    </td>
                </tr>
            </tbody>

        </table>

        <script>(function () { "use strict";

            $.support.cors = true;

            var viewModel = { types:  ko.observableArray(),
                              errors: ko.observableArray() };

            $(document).ajaxError(
                function (event, request, settings, errorThrown) {

                viewModel.errors.push({ message: errorThrown });
            });

            ko.applyBindings(viewModel);

            var cubeBaseUrl = "http://eventcube.red-gate.com/1.0/";

            var getLastMessageUrl = function (type) {

                var parameters = {
                    expression: type + "(payload,headers,messageType)",
                    limit:      1 };

                return cubeBaseUrl + "event?" + $.param(parameters);
            };

            var getTotalMetricsUrl = function (type, period, limit) {

                var parameters = { expression: "sum(" + type + ")",
                                   step:       period,
                                   limit:      limit };

                return cubeBaseUrl + "metric?" + $.param(parameters);
            };

            $.get(cubeBaseUrl + "types").then(function (types) {

                types = types.filter(function (type) {

                    var ignoredMessageTypes = ["cube_compute", "cube_request"];

                    return ignoredMessageTypes.indexOf(type) === -1;
                });

                types.forEach(function (typeName) {

                    var typeData = {

                        type: {

                            value: typeName,
                            url:   getLastMessageUrl(typeName)
                        },

                        totalInLastCompletedHour: {

                            value: ko.observable('...'),
                            url:   getTotalMetricsUrl(typeName, '36e5', 5)
                        },

                        totalInLastCompletedDay: {

                            value: ko.observable('...'),
                            url:   getTotalMetricsUrl(typeName, '864e5', 5)
                        }
                    };

                    viewModel.types.push(typeData);

                    $.get(getTotalMetricsUrl(typeName, '36e5', 1))
                     .then(function (response) {

                        typeData.totalInLastCompletedHour.value(response[0].value);
                    });

                    $.get(getTotalMetricsUrl(typeName, '864e5', 1))
                     .then(function (response) {

                        typeData.totalInLastCompletedDay.value(response[0].value);
                    });
                });
            });

        }());</script>

    </body>

</html>